# Linuxdo Auto Browse 分批追加队列设计

**目标**：避免一次性抓取大量帖子导致 429/CF 限流，同时支持“边读边追加”，每批最多 150 条，且维持历史去重。

## 架构与数据流
- 将队列构建改为流式追加：剩余队列低于阈值时再补充下一批。
- 每批抓取最多 150 条，按少量分页请求分摊访问；读完即可继续补批。
- 请求节奏加入冷却时间 + 随机抖动，避免连续高频。
- 429 时进入指数退避，必要时回退 DOM 抓取或暂停提示。

## 状态与流程细节
- 持久化状态：`batchSize`、`lowWater`、`nextApiUrl`、`fetching`、`lastFetchAt`、`nextFetchAt`、`backoffCount`、`history`。
- 触发条件：队列剩余 < lowWater 且未达目标数量。
- 触发动作：若 `Date.now() >= nextFetchAt` 且 `!fetching`，执行 `fetchMore()`。
- `fetchMore()`：每次最多拉 2–3 页直到累计 150 条或无 `more_topics_url`；用 `fetchWithTimeout`；每次请求前 2–5 秒随机抖动。
- 429 处理：`backoffCount++`，`nextFetchAt = now + backoff`，暂停本次追加；超过阈值可回退 DOM 或显示“冷却中”。
- 去重：对比历史集合过滤已读条目，新增条目追加到队列末尾，不中断当前阅读。

## 错误处理与测试
- 超时/异常：本次追加失败，保留队列与指针，等待下次触发。
- 429：指数退避（例如 30s→60s→120s→…，上限 10 分钟）。
- 测试：逻辑层新增批次/退避/去重函数单测；内容脚本做手工验证（低水位触发、429 退避、DOM 回退、不中断运行）。

